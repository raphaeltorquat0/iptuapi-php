name: Update SDK Status

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  schedule:
    - cron: '0 7 * * *'  # Daily at 7 AM UTC (after validation)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-status:
    name: Update SDK Status
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Get latest version from Packagist
        id: packagist_version
        run: |
          VERSION=$(curl -s "https://repo.packagist.org/p2/raphaeltorquat0/iptuapi-php.json" | jq -r '.packages["raphaeltorquat0/iptuapi-php"][0].version' 2>/dev/null || echo "not published")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest Packagist version: $VERSION"

      - name: Get composer.json version
        id: pkg_version
        run: |
          VERSION=$(jq -r '.version // "dev"' composer.json)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "composer.json version: $VERSION"

      - name: Run validation check
        id: validation
        continue-on-error: true
        run: |
          mkdir -p /tmp/status-check
          cd /tmp/status-check
          composer init --name="test/status-check" --no-interaction
          composer config minimum-stability dev
          composer config prefer-stable true
          composer require raphaeltorquat0/iptuapi-php 2>/dev/null

          # Test import
          if php -r "require 'vendor/autoload.php'; use IPTUApi\IPTUClient; echo 'OK';" 2>/dev/null; then
            echo "STATUS=passing" >> $GITHUB_OUTPUT
          else
            echo "STATUS=failing" >> $GITHUB_OUTPUT
          fi

      - name: Get current date
        id: date
        run: echo "DATE=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT

      - name: Update SDK-STATUS.md
        run: |
          cat > SDK-STATUS.md << 'EOF'
          # SDK Status

          > Auto-generated status file. Last updated: ${{ steps.date.outputs.DATE }}

          ## Version Information

          | Metric | Value |
          |--------|-------|
          | **Latest Published** | ${{ steps.packagist_version.outputs.VERSION }} |
          | **Source Version** | ${{ steps.pkg_version.outputs.VERSION }} |
          | **Registry** | Packagist (packagist.org) |
          | **Package** | raphaeltorquat0/iptuapi-php |

          ## Validation Status

          | Check | Status |
          |-------|--------|
          | **Clean Install** | ${{ steps.validation.outputs.STATUS == 'passing' && '✅ Passing' || '❌ Failing' }} |
          | **Autoload** | ${{ steps.validation.outputs.STATUS == 'passing' && '✅ Passing' || '❌ Failing' }} |

          ## Compatibility

          | PHP Version | Status |
          |-------------|--------|
          | 8.1 | ✅ Supported |
          | 8.2 | ✅ Supported |
          | 8.3 | ✅ Supported |

          ## Links

          - [Packagist Package](https://packagist.org/packages/raphaeltorquat0/iptuapi-php)
          - [API Documentation](https://docs.iptuapi.com.br)
          - [GitHub Repository](https://github.com/raphaeltorquat0/iptuapi-php)

          ---
          *This file is automatically updated by GitHub Actions.*
          EOF

      - name: Commit status update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add SDK-STATUS.md
          git diff --staged --quiet || git commit -m "chore: update SDK status [skip ci]"
          git push || echo "No changes to push"
