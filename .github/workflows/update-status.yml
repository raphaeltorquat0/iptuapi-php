name: Update SDK Status

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7 AM UTC (after validation)

permissions:
  contents: write

jobs:
  update-status:
    name: Update SDK Status
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest version
        id: version
        run: |
          VERSION=$(jq -r '.version // "unknown"' composer.json)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Get validation status
        id: validation
        run: |
          VALIDATION_STATUS=$(gh run list --workflow=sdk-validation.yml --limit 1 --json conclusion --jq '.[0].conclusion // "unknown"')
          if [ "$VALIDATION_STATUS" = "success" ]; then
            echo "STATUS=FUNCIONAL" >> $GITHUB_OUTPUT
            echo "EMOJI=ðŸŸ¢" >> $GITHUB_OUTPUT
          else
            echo "STATUS=VERIFICAR" >> $GITHUB_OUTPUT
            echo "EMOJI=ðŸŸ¡" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update SDK-STATUS.md
        run: |
          DATE=$(date -u +%Y-%m-%d)
          VERSION="${{ steps.version.outputs.VERSION }}"
          STATUS="${{ steps.validation.outputs.STATUS }}"
          EMOJI="${{ steps.validation.outputs.EMOJI }}"
          
          cat > SDK-STATUS.md << EOF
          # PHP SDK Status

          **Ãšltima atualizaÃ§Ã£o:** ${DATE}
          **VersÃ£o:** ${VERSION}
          **Status:** ${EMOJI} ${STATUS}

          ---

          ## InformaÃ§Ãµes

          | Item | Valor |
          |------|-------|
          | **VersÃ£o** | ${VERSION} |
          | **Registry** | Packagist (\`composer require raphaeltorquat0/iptuapi-php\`) |
          | **Status** | ${EMOJI} ${STATUS} |
          | **MÃ­nimo** | PHP 8.1+ |

          ## InstalaÃ§Ã£o

          \`\`\`bash
          composer require raphaeltorquat0/iptuapi-php
          \`\`\`

          ## Exemplo RÃ¡pido

          \`\`\`php
          <?php
          require_once 'vendor/autoload.php';

          use IPTUAPI\IPTUClient;

          \$client = new IPTUClient('sua_api_key');
          \$cidades = \$client->iptuToolsCidades();
          echo "{\$cidades['total']} cidades disponÃ­veis";
          \`\`\`

          ## ValidaÃ§Ã£o AutomÃ¡tica

          Este SDK Ã© validado automaticamente:
          - âœ… InstalaÃ§Ã£o limpa via Composer
          - âœ… Autoload do pacote
          - âœ… Teste contra API real (\`iptuToolsCidades\`)
          - âœ… Teste autenticado (\`consultaEndereco\`)

          ---

          *Atualizado automaticamente pelo CI/CD*
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add SDK-STATUS.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update SDK status [skip ci]"
            git push
          fi
